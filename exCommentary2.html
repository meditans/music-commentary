<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>exCommentary2</title>
<!-- 2014-12-21 Sun 15:44 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Carlo Nucera" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">exCommentary2</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Second installment</a>
<ul>
<li><a href="#sec-1-1">1.1. Two Parts First Species Counterpoint</a></li>
<li><a href="#sec-1-2">1.2. Getters to access the upper and lower voices</a></li>
<li><a href="#sec-1-3">1.3. Rendering a simple realization of a counterpoint exercise</a></li>
<li><a href="#sec-1-4">1.4. Changing clefs and instrument name</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Second installment</h2>
<div class="outline-text-2" id="text-1">
<p>
Here is the second installment in the series which explores the
functioning of the music-suite library. Here is the code we wrote
last time:
</p>

<div class="org-src-container">

<pre class="src src-haskell">import Music.Prelude

permittedMelodicIntervals :: [Interval]
permittedMelodicIntervals = [ perfect unison, major second, minor second
                            , major third,    minor third,  perfect fourth
                            , perfect fifth,  major sixth,  minor sixth
                            , perfect octave]

type CounterpointVoice = Aligned (Voice Pitch)

cantus :: CounterpointVoice 
cantus = [d, a, g, f, e, d, f, e, d] ^. voice . to (aligned 0 0)

render :: CounterpointVoice -&gt; Score StandardNote
render = fmap (fromPitch' . pure) . renderAlignedVoice 

action :: IO ()
action = writeLilypond "cantus.ly" $ render cantus
</pre>
</div>

<p>
So, our final goal is to write a counterpoint over a cantus firmus and
check their mutual relationship, in a generic way (ie. a way that will
work when we will begin to write exercices in three parts).  We begin
here by representing an exercise.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Two Parts First Species Counterpoint</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Last time, we used counterpointVoice to model a voice. Let's model
a two parts first species counterpoint. For musical theoretical
reasons, we want to distinguish the position of the cantus with
respect to that of the counterpoint itself. The first design that
comes in mind is:
</p>

<div class="org-src-container">

<pre class="src src-haskell">-- Two parts first species counterpoint
data TPFSC = TPFSC { topVoice :: CounterpointVoice
                   , bottomVoice :: CounterpointVoice
                   } deriving (Eq, Show)
</pre>
</div>

<p>
Here arises a problem. The Eq deriving is incorrect, as the program
doesn't know how to derive the Eq instance for CounterpointVoice.
Why is this? We know that:
</p>

<pre class="example">
counterpointVoice = Aligned (Voice Pitch)
</pre>

<p>
So, let's look at <code>Eq</code> instance for <code>Aligned</code>. Ok, there isn't one
(there is the <code>Show</code> one, however). Is that necessary by design?
For now, let's remove the <code>Eq</code> instance, however. Let's also
include a smart constructor for counterpoints to concentrate on the
pitches, without worrying about the plumbing.
</p>

<div class="org-src-container">

<pre class="src src-haskell">data TPFSC = TPFSC { _cantusFirmus :: CounterpointVoice
                   , _counterpoint :: CounterpointVoice
                   } deriving (Show)

makeLenses ''TPFSC

tpfsc :: [Note Pitch] -&gt; [Note Pitch] -&gt; TPFSC
tpfsc a b = TPFSC
  { _counterpoint = a ^. voice . to (aligned 0 0)
  , _cantusFirmus = b ^. voice . to (aligned 0 0)
  }
</pre>
</div>

<p>
With this, we can write:
</p>

<div class="org-src-container">

<pre class="src src-haskell">example :: TPFSC
example = TPFSC
  { _cantusFirmus = [d, a, g, f, e, d, f, e, d] ^. voice . to (aligned 0 0)
  , _counterpoint = (_8va [d, c, e, f, g, f, d, cs, d]) ^. voice . to (aligned 0 0)
  }

example' :: TPFSC
example' = tpfsc [d, a, g, f, e, d, f, e, d] (_8va [d, c, e, f, g, f, d, cs, d])
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Getters to access the upper and lower voices</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Two check that the rules of simple counterpoint hold, we have two
needs:
</p>
<ol class="org-ol">
<li>Being able to distinguish the upper from the lower voice. 
</li>
<li>Being able to distinguish the cantus firmus from the counterpoint
exercise.
</li>
</ol>

<p>
Now, the cantus/counterpoint information is stored in the data
itself, so let's think how to access the upper/lower voice.
</p>

<p>
How do we know which voice is higher? It suffices to check the
first note (as we're not permitting voice overlapping).  After a
bit of thougth, I think I have two possibilities:
</p>

<dl class="org-dl">
<dt> Using a getter </dt><dd>this solution is totally correct, but I have
the downside of not being able to change the upper part, if I
want.
</dd>
<dt> Using a misbehaved lens </dt><dd>(It's misbehaved because I could
modify the upper voice transforming it into wht lower one) I
generally don't like to break laws in my code, but this could
give me the possibility of changing the last note of the upper
part.
</dd>
</dl>

<p>
As I find the possibility to change something in the upper part not
so tremendously useful, I'll make a getter (id est, a function xd).
</p>

<div class="org-src-container">

<pre class="src src-haskell">upperVoice :: TPFSC -&gt; CounterpointVoice
upperVoice c = if c^.cantusFirmus.firstNote &gt;= c^.counterpoint.firstNote
               then c^.cantusFirmus
               else c^.counterpoint
    where
      firstNote :: Lens' CounterpointVoice Pitch
      firstNote = undefined
</pre>
</div>

<p>
Now, the point is, I want to write the lens firstNote, so first
thing would be to read inside the Aligned constructor. In the
documentation of aligned, I don't seem to find a lens doing that.
</p>

<p>
This is a difficulty that I encounter often while toying with the
library: often there is a constructor, which lets me create an
object, and I'm unable to locate easily the corresponding
destructor (or, eventually, the getter).
</p>

<p>
Oh, there is something that converts an <code>Aligned (Voice a)</code> to a
<code>Score a</code>. So, let's see if I can read with a lens inside of a
<code>Score a</code>. It seems that I can read an <code>Event a</code> which exposes an
iso to <code>(Span, a)</code>. So, after that Iso, and _2, I'm getting the
Pitch. Let's verify this intuition in ghci.
</p>

<pre class="example">
ghci&gt; :t cantus ^?! (to renderAlignedVoice . events . traverse . from event . _2)
cantus ^?! (to renderAlignedVoice . events . traverse . from event . _2) :: Pitch

ghci&gt; cantus ^?! (to renderAlignedVoice . events . traverse . from event . _2)
d
</pre>

<p>
However, this process, while possible, should in my opinion be streamlined.
</p>

<p>
So, in the end:
</p>

<div class="org-src-container">

<pre class="src src-haskell">upperVoice :: TPFSC -&gt; CounterpointVoice
upperVoice c = if c^?!cantusFirmus.firstNote &gt;= c^?!counterpoint.firstNote
               then c^.cantusFirmus
               else c^.counterpoint
    where
      firstNote = to renderAlignedVoice . events . traverse . from event . _2

lowerVoice :: TPFSC -&gt; CounterpointVoice
lowerVoice c = if c^?!cantusFirmus.firstNote &gt;= c^?!counterpoint.firstNote
               then c^.counterpoint
               else c^.cantusFirmus
    where
      firstNote = to renderAlignedVoice . events . traverse . from event . _2
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Rendering a simple realization of a counterpoint exercise</h3>
<div class="outline-text-3" id="text-1-3">
<p>
So, let's write a simple realization of the cantus firmus.
</p>

<div class="org-src-container">

<pre class="src src-haskell">example = TPFSC
 { _cantusFirmus = [d, a, g, f, e, d, f, e, d] ^. voice . to (aligned 0 0)
 , _counterpoint = [d', a, g, f, e, d, f, e, d] ^. voice . to (aligned 0 0)
 }
</pre>
</div>

<p>
Now, let's move towards the rendering of this exercise. Now, the
difficulty is the fact that we used the function
<code>renderAlignedVoice</code>, which has type <code>Aligned (Voice Pitch) -&gt;
   Score Pitch</code>. How do we extend this to the two voices?
</p>

<p>
Let's explore the <code>Aligned</code> module. Nothing. Ok, can we merge two
<code>Score Pitch</code>? Well, it's an istance of monoid, and I do not see
other merge function on first sight, so let's try:
</p>

<div class="org-src-container">

<pre class="src src-haskell">renderTPFSC :: TPFSC -&gt; IO ()
renderTPFSC es = writeLilypond "composto.ly" $
                               (render . upperVoice $ es) &lt;&gt; (render . lowerVoice $ es)
</pre>
</div>

<p>
Ok, that was good, but we have both voices in the same
pentagram. Now, I'd like to be able to split the exercise using two
pentagrams. For that, I'm going to check the documentation. In fact
this is well expressed in the docs. The point is the <code>&lt;/&gt;</code>
operator, so:
</p>

<div class="org-src-container">

<pre class="src src-haskell">renderTPFSC :: TPFSC -&gt; IO ()
renderTPFSC es = writeLilypond "composto.ly" $
                               (render . upperVoice $ es) &lt;/&gt; (render . lowerVoice $ es)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Changing clefs and instrument name</h3>
<div class="outline-text-3" id="text-1-4">
<p>
We now have only to change the default keys, using the module
<code>Music.Score.Meta.Clef</code>. My first try is:
</p>

<div class="org-src-container">

<pre class="src src-haskell">renderTPFSCWithClef :: TPFSC -&gt; IO ()
renderTPFSCWithClef es = writeLilypond "composto.ly" $
                               (render . upperVoice $ es) &lt;/&gt; (render . clef CClef . lowerVoice $ es)
</pre>
</div>

<p>
Argh, it doesn't work, and the docs have a TODO marked for an
example :P. I think this is because <code>CounterpointVoice = Aligned
   (Voice Pitch)</code> lacks a <code>HasMeta</code> instance. But <code>Score</code> does have
one, so let's try:
</p>

<div class="org-src-container">

<pre class="src src-haskell">renderTPFSCWithClef :: TPFSC -&gt; IO ()
renderTPFSCWithClef es = writeLilypond "composto.ly" $
                               (render . upperVoice $ es) &lt;/&gt; clef CClef (render . lowerVoice $ es)
</pre>
</div>

<p>
Well, this does compile, but <b>the result is unchanged</b>. Why is this?
What should I do to change the lower clef?
</p>

<p>
To end this installment, I'll pose a question: how do I eliminate
instruments annotations from the generated pdf? I wasn't able to
find anything like that in the documentation.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Carlo Nucera</p>
<p class="date">Created: 2014-12-21 Sun 15:44</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.4.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
